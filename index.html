<?php
// ============================================
// PHP BACKEND FOR JSON FILE HANDLING
// ============================================
$jsonFile = 'inventory_data.json';
$historyFile = 'stock_history.json';

// Handle API requests
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_GET['action'])) {
    header('Content-Type: application/json');
    $action = $_GET['action'];
    
    switch ($action) {
        case 'load':
            echo loadData();
            break;
        case 'save':
            echo saveData();
            break;
        case 'backup':
            echo createBackup();
            break;
        case 'check':
            echo checkFile();
            break;
        case 'load_history':
            echo loadHistory();
            break;
        case 'save_history':
            echo saveHistory();
            break;
        case 'get_item_history':
            echo getItemHistory();
            break;
        default:
            echo json_encode(['success' => false, 'message' => 'Invalid action']);
    }
    exit;
}

function checkFile() {
    global $jsonFile, $historyFile;
    
    $results = [
        'inventory' => ['exists' => false, 'size' => 0, 'has_data' => false],
        'history' => ['exists' => false, 'size' => 0, 'has_data' => false]
    ];
    
    if (file_exists($jsonFile)) {
        $results['inventory']['exists'] = true;
        $results['inventory']['size'] = filesize($jsonFile);
        $content = file_get_contents($jsonFile);
        $data = json_decode($content, true);
        $results['inventory']['has_data'] = !empty($data) && isset($data['items']);
    }
    
    if (file_exists($historyFile)) {
        $results['history']['exists'] = true;
        $results['history']['size'] = filesize($historyFile);
        $content = file_get_contents($historyFile);
        $data = json_decode($content, true);
        $results['history']['has_data'] = !empty($data) && isset($data['transactions']);
    }
    
    return json_encode([
        'success' => true,
        'file_exists' => true,
        'results' => $results
    ]);
}

function loadData() {
    global $jsonFile;
    
    if (!file_exists($jsonFile)) {
        // Create initial JSON file with sample data matching the provided format
        $sampleData = [
            [
                "itemCode" => "WAD - OS - 001",
                "no" => 1,
                "description" => "Aluminum Egg Crate sheet New",
                "unit" => "Nos",
                "unitPrice" => 14234.00,
                "in" => null,
                "out" => 3,
                "balance" => 46.00,
                "value" => 654764.00
            ],
            [
                "itemCode" => "WAD - MR - 001",
                "no" => 2,
                "description" => "G.I.Mesh (Green) 1/2 *1/2 New",
                "unit" => "Meter",
                "unitPrice" => 600.00,
                "in" => null,
                "out" => null,
                "balance" => 30.00,
                "value" => 18000.00
            ]
        ];
        
        $initialData = [
            'company' => 'Western Airducts Lanka (Pvt) Ltd',
            'reportTitle' => 'Stock balance as at 31.12.2025',
            'items' => $sampleData,
            'categories' => [
                'ALLUMINIUM EGG CRATES',
                'ALLUMINIUM PROFILES',
                'G.I. COILS',
                'G.I. SHEETS',
                'SQUARE DUCT FLANGERS',
                'SQUARE DUCT CORNERS',
                'SQUARE DUCT CLEATS',
                'GASKET TAPE',
                'OTHER MATERIAL',
                'V.C.D. WHEELS',
                'POWDER COATING',
                'STORES ITEMS',
                'DRILL BITS',
                'POP RIVETS',
                'UN PRINTED CARTONS'
            ],
            'metadata' => [
                'created' => date('Y-m-d H:i:s'),
                'last_updated' => date('Y-m-d H:i:s'),
                'total_items' => count($sampleData),
                'total_value' => array_sum(array_column($sampleData, 'value'))
            ]
        ];
        
        if (file_put_contents($jsonFile, json_encode($initialData, JSON_PRETTY_PRINT))) {
            // Format the data for frontend (add id field)
            $formattedData = array_map(function($item) {
                return [
                    'id' => $item['no'],
                    'itemCode' => $item['itemCode'],
                    'no' => $item['no'],
                    'description' => $item['description'],
                    'unit' => $item['unit'],
                    'unitPrice' => $item['unitPrice'],
                    'stockIn' => $item['in'] ?? 0,
                    'stockOut' => $item['out'] ?? 0,
                    'balance' => $item['balance'],
                    'value' => $item['value'],
                    'category' => determineCategory($item['itemCode']),
                    'notes' => ''
                ];
            }, $sampleData);
            
            // Create initial history file
            createInitialHistoryFile();
            
            return json_encode([
                'success' => true, 
                'data' => $formattedData,
                'message' => 'Created new JSON file with sample data'
            ]);
        } else {
            return json_encode([
                'success' => false, 
                'message' => 'Failed to create JSON file'
            ]);
        }
    }
    
    try {
        $content = file_get_contents($jsonFile);
        
        if ($content === false) {
            throw new Exception('Cannot read JSON file');
        }
        
        $data = json_decode($content, true);
        
        if (json_last_error() !== JSON_ERROR_NONE) {
            throw new Exception('Invalid JSON format: ' . json_last_error_msg());
        }
        
        if (!isset($data['items'])) {
            throw new Exception('Invalid data structure: missing items key');
        }
        
        // Format the data for frontend
        $formattedData = [];
        foreach ($data['items'] as $item) {
            $formattedData[] = [
                'id' => $item['no'] ?? null,
                'itemCode' => $item['itemCode'] ?? '',
                'no' => $item['no'] ?? null,
                'description' => $item['description'] ?? '',
                'unit' => $item['unit'] ?? '',
                'unitPrice' => floatval($item['unitPrice'] ?? 0),
                'stockIn' => $item['in'] ?? 0,
                'stockOut' => $item['out'] ?? 0,
                'balance' => floatval($item['balance'] ?? 0),
                'value' => floatval($item['value'] ?? 0),
                'category' => determineCategory($item['itemCode'] ?? ''),
                'notes' => ''
            ];
        }
        
        return json_encode([
            'success' => true, 
            'data' => $formattedData,
            'metadata' => $data['metadata'] ?? [],
            'categories' => $data['categories'] ?? [],
            'company' => $data['company'] ?? '',
            'reportTitle' => $data['reportTitle'] ?? '',
            'message' => 'Data loaded successfully'
        ]);
        
    } catch (Exception $e) {
        return json_encode([
            'success' => false, 
            'message' => $e->getMessage(),
            'error' => json_last_error_msg()
        ]);
    }
}

function saveData() {
    global $jsonFile;
    
    try {
        // Read raw input
        $rawInput = file_get_contents('php://input');
        
        if (empty($rawInput)) {
            throw new Exception('No data received in request');
        }
        
        $input = json_decode($rawInput, true);
        
        if (json_last_error() !== JSON_ERROR_NONE) {
            throw new Exception('Invalid JSON in request: ' . json_last_error_msg());
        }
        
        if (!$input || !isset($input['data'])) {
            throw new Exception('Missing data field in request');
        }
        
        $inventoryData = $input['data'];
        
        // Validate data
        if (!is_array($inventoryData)) {
            throw new Exception('Data must be an array');
        }
        
        // Create backup directory if needed
        $backupDir = 'backups';
        if (!is_dir($backupDir)) {
            if (!mkdir($backupDir, 0755, true)) {
                throw new Exception('Failed to create backup directory');
            }
        }
        
        // Create backup before saving (if file exists)
        if (file_exists($jsonFile)) {
            $backupFile = $backupDir . '/inventory_backup_' . date('Y-m-d_H-i-s') . '.json';
            if (!copy($jsonFile, $backupFile)) {
                throw new Exception('Failed to create backup');
            }
        }
        
        // Convert frontend data to backend format
        $backendItems = [];
        foreach ($inventoryData as $item) {
            $backendItems[] = [
                'itemCode' => $item['itemCode'] ?? '',
                'no' => $item['no'] ?? $item['id'] ?? null,
                'description' => $item['description'] ?? '',
                'unit' => $item['unit'] ?? '',
                'unitPrice' => floatval($item['unitPrice'] ?? 0),
                'in' => $item['stockIn'] ?? 0,
                'out' => $item['stockOut'] ?? 0,
                'balance' => floatval($item['balance'] ?? 0),
                'value' => floatval($item['value'] ?? 0)
            ];
        }
        
        // Calculate totals
        $totalValue = 0;
        foreach ($backendItems as $item) {
            $totalValue += floatval($item['value'] ?? 0);
        }
        
        // Determine categories from item codes
        $categories = [];
        foreach ($backendItems as $item) {
            $category = determineCategory($item['itemCode']);
            if ($category && !in_array($category, $categories)) {
                $categories[] = $category;
            }
        }
        sort($categories);
        
        // Prepare data for saving (matching the provided JSON format)
        $data = [
            'company' => 'Western Airducts Lanka (Pvt) Ltd',
            'reportTitle' => 'Stock balance as at 31.12.2025',
            'items' => $backendItems,
            'categories' => $categories,
            'metadata' => [
                'last_updated' => date('Y-m-d H:i:s'),
                'total_items' => count($backendItems),
                'total_value' => $totalValue
            ]
        ];
        
        // Save to JSON file
        $result = file_put_contents($jsonFile, json_encode($data, JSON_PRETTY_PRINT));
        
        if ($result === false) {
            throw new Exception('Failed to write to JSON file. Check file permissions.');
        }
        
        // Verify the file was written
        if (!file_exists($jsonFile)) {
            throw new Exception('JSON file was not created');
        }
        
        $fileSize = filesize($jsonFile);
        
        return json_encode([
            'success' => true, 
            'message' => 'Data saved successfully to JSON file',
            'timestamp' => date('Y-m-d H:i:s'),
            'total_items' => count($backendItems),
            'total_value' => $totalValue,
            'file_size' => $fileSize,
            'file_path' => realpath($jsonFile)
        ]);
        
    } catch (Exception $e) {
        return json_encode([
            'success' => false, 
            'message' => 'Error: ' . $e->getMessage(),
            'debug' => [
                'raw_input_length' => strlen($rawInput ?? ''),
                'input_decoded' => !empty($input),
                'file_exists' => file_exists($jsonFile),
                'file_writable' => is_writable(dirname($jsonFile))
            ]
        ]);
    }
}

function createBackup() {
    global $jsonFile, $historyFile;
    
    $backupDir = 'backups';
    if (!is_dir($backupDir)) {
        if (!mkdir($backupDir, 0755, true)) {
            return json_encode([
                'success' => false, 
                'message' => 'Failed to create backup directory'
            ]);
        }
    }
    
    $timestamp = date('Y-m-d_H-i-s');
    $backupsCreated = [];
    
    // Backup inventory file
    if (file_exists($jsonFile)) {
        $backupFile = $backupDir . '/inventory_backup_' . $timestamp . '.json';
        if (copy($jsonFile, $backupFile)) {
            $backupsCreated[] = [
                'type' => 'inventory',
                'file' => $backupFile,
                'size' => filesize($backupFile)
            ];
        }
    }
    
    // Backup history file
    if (file_exists($historyFile)) {
        $backupFile = $backupDir . '/history_backup_' . $timestamp . '.json';
        if (copy($historyFile, $backupFile)) {
            $backupsCreated[] = [
                'type' => 'history',
                'file' => $backupFile,
                'size' => filesize($backupFile)
            ];
        }
    }
    
    if (!empty($backupsCreated)) {
        return json_encode([
            'success' => true, 
            'message' => 'Backup created successfully',
            'backups' => $backupsCreated
        ]);
    } else {
        return json_encode([
            'success' => false, 
            'message' => 'No data files found to backup'
        ]);
    }
}

function loadHistory() {
    global $historyFile;
    
    if (!file_exists($historyFile)) {
        createInitialHistoryFile();
    }
    
    try {
        $content = file_get_contents($historyFile);
        
        if ($content === false) {
            throw new Exception('Cannot read history file');
        }
        
        $data = json_decode($content, true);
        
        if (json_last_error() !== JSON_ERROR_NONE) {
            throw new Exception('Invalid JSON format: ' . json_last_error_msg());
        }
        
        return json_encode([
            'success' => true, 
            'data' => $data['transactions'] ?? [],
            'metadata' => $data['metadata'] ?? [],
            'message' => 'History data loaded successfully'
        ]);
        
    } catch (Exception $e) {
        return json_encode([
            'success' => false, 
            'message' => $e->getMessage()
        ]);
    }
}

function saveHistory() {
    global $historyFile;
    
    try {
        // Read raw input
        $rawInput = file_get_contents('php://input');
        
        if (empty($rawInput)) {
            throw new Exception('No data received in request');
        }
        
        $input = json_decode($rawInput, true);
        
        if (json_last_error() !== JSON_ERROR_NONE) {
            throw new Exception('Invalid JSON in request: ' . json_last_error_msg());
        }
        
        if (!$input || !isset($input['transactions'])) {
            throw new Exception('Missing transactions field in request');
        }
        
        $transactions = $input['transactions'];
        
        // Create backup directory if needed
        $backupDir = 'backups';
        if (!is_dir($backupDir)) {
            if (!mkdir($backupDir, 0755, true)) {
                throw new Exception('Failed to create backup directory');
            }
        }
        
        // Create backup before saving (if file exists)
        if (file_exists($historyFile)) {
            $backupFile = $backupDir . '/history_backup_' . date('Y-m-d_H-i-s') . '.json';
            if (!copy($historyFile, $backupFile)) {
                throw new Exception('Failed to create backup');
            }
        }
        
        // Load existing history
        $existingHistory = [];
        if (file_exists($historyFile)) {
            $content = file_get_contents($historyFile);
            if ($content !== false) {
                $existingData = json_decode($content, true);
                if ($existingData && isset($existingData['transactions'])) {
                    $existingHistory = $existingData['transactions'];
                }
            }
        }
        
        // Merge with new transactions
        $allTransactions = array_merge($existingHistory, $transactions);
        
        // Sort by date (newest first)
        usort($allTransactions, function($a, $b) {
            return strtotime($b['date']) - strtotime($a['date']);
        });
        
        // Keep only latest 1000 transactions to prevent file bloat
        if (count($allTransactions) > 1000) {
            $allTransactions = array_slice($allTransactions, 0, 1000);
        }
        
        // Prepare data for saving
        $data = [
            'metadata' => [
                'last_updated' => date('Y-m-d H:i:s'),
                'total_transactions' => count($allTransactions),
                'oldest_transaction' => !empty($allTransactions) ? end($allTransactions)['date'] : null,
                'newest_transaction' => !empty($allTransactions) ? $allTransactions[0]['date'] : null
            ],
            'transactions' => $allTransactions
        ];
        
        // Save to JSON file
        $result = file_put_contents($historyFile, json_encode($data, JSON_PRETTY_PRINT));
        
        if ($result === false) {
            throw new Exception('Failed to write to history file. Check file permissions.');
        }
        
        return json_encode([
            'success' => true, 
            'message' => 'History saved successfully',
            'timestamp' => date('Y-m-d H:i:s'),
            'total_transactions' => count($allTransactions)
        ]);
        
    } catch (Exception $e) {
        return json_encode([
            'success' => false, 
            'message' => 'Error: ' . $e->getMessage()
        ]);
    }
}

function getItemHistory() {
    global $historyFile;
    
    try {
        if (!file_exists($historyFile)) {
            return json_encode([
                'success' => true, 
                'data' => [],
                'message' => 'No history file found'
            ]);
        }
        
        $content = file_get_contents($historyFile);
        
        if ($content === false) {
            throw new Exception('Cannot read history file');
        }
        
        $data = json_decode($content, true);
        
        if (json_last_error() !== JSON_ERROR_NONE) {
            throw new Exception('Invalid JSON format: ' . json_last_error_msg());
        }
        
        $transactions = $data['transactions'] ?? [];
        
        // Filter by item if specified
        if (isset($_GET['itemCode'])) {
            $itemCode = $_GET['itemCode'];
            $filteredTransactions = array_filter($transactions, function($transaction) use ($itemCode) {
                return $transaction['itemCode'] === $itemCode;
            });
            $transactions = array_values($filteredTransactions);
        }
        
        // Filter by date range if specified
        if (isset($_GET['startDate']) && isset($_GET['endDate'])) {
            $startDate = strtotime($_GET['startDate']);
            $endDate = strtotime($_GET['endDate']);
            
            $filteredTransactions = array_filter($transactions, function($transaction) use ($startDate, $endDate) {
                $transactionDate = strtotime($transaction['date']);
                return $transactionDate >= $startDate && $transactionDate <= $endDate;
            });
            $transactions = array_values($filteredTransactions);
        }
        
        // Limit results if specified
        if (isset($_GET['limit'])) {
            $limit = intval($_GET['limit']);
            $transactions = array_slice($transactions, 0, $limit);
        }
        
        return json_encode([
            'success' => true, 
            'data' => $transactions,
            'total' => count($transactions),
            'message' => 'Item history loaded successfully'
        ]);
        
    } catch (Exception $e) {
        return json_encode([
            'success' => false, 
            'message' => $e->getMessage()
        ]);
    }
}

function createInitialHistoryFile() {
    global $historyFile;
    
    $initialData = [
        'metadata' => [
            'created' => date('Y-m-d H:i:s'),
            'last_updated' => date('Y-m-d H:i:s'),
            'total_transactions' => 0
        ],
        'transactions' => []
    ];
    
    file_put_contents($historyFile, json_encode($initialData, JSON_PRETTY_PRINT));
}

// Helper function to determine category from item code
function determineCategory($itemCode) {
    $categoryMap = [
        'WAD - OS' => 'ALLUMINIUM EGG CRATES',
        'WAD -AP' => 'ALLUMINIUM PROFILES',
        'WAD - GC' => 'G.I. COILS',
        'WAD - GS' => 'G.I. SHEETS',
        'WAD - OS -' => 'ALLUMINIUM EGG CRATES',
        'WAD - MR' => 'ALLUMINIUM EGG CRATES',
        'WAD - SD' => 'SQUARE DUCT FLANGERS',
        'WAD - DW' => 'V.C.D. WHEELS',
        'WAD - PC' => 'POWDER COATING',
        'WAD - SI' => 'STORES ITEMS',
        'WAD - DB' => 'DRILL BITS',
        'WAD - PR' => 'POP RIVETS',
        'WAD - UP' => 'UN PRINTED CARTONS',
        'WAD - OM' => 'OTHER MATERIAL'
    ];
    
    foreach ($categoryMap as $prefix => $category) {
        if (strpos($itemCode, $prefix) === 0) {
            return $category;
        }
    }
    
    return 'OTHER MATERIAL';
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Western Airducts Lanka - Inventory System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #1a3a8f 0%, #2c5aa0 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            font-size: 2.5rem;
            color: #ffcc00;
        }
        
        .company-name {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .company-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .current-date {
            text-align: right;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 5px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            margin-bottom: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tab:hover {
            background-color: #f8f9fa;
            color: #1a3a8f;
        }
        
        .tab.active {
            color: #1a3a8f;
            border-bottom: 3px solid #1a3a8f;
            background-color: #f8f9fa;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Control Panel */
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #1a3a8f;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #152b6f;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #138496;
            transform: translateY(-2px);
        }
        
        .btn-purple {
            background-color: #6f42c1;
            color: white;
        }
        
        .btn-purple:hover {
            background-color: #59359e;
            transform: translateY(-2px);
        }
        
        .search-box {
            flex-grow: 1;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }
        
        /* Status Panel */
        .status-panel {
            background: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .status-panel h3 {
            color: #2e7d32;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 0.9rem;
        }
        
        .status-item {
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #c8e6c9;
        }
        
        .status-item strong {
            color: #2e7d32;
            margin-right: 5px;
        }
        
        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        
        .stat-icon.blue {
            background-color: #e3f2fd;
            color: #1a3a8f;
        }
        
        .stat-icon.green {
            background-color: #e8f5e9;
            color: #28a745;
        }
        
        .stat-icon.orange {
            background-color: #fff3e0;
            color: #ff9800;
        }
        
        .stat-icon.red {
            background-color: #ffebee;
            color: #dc3545;
        }
        
        .stat-icon.purple {
            background-color: #f3e5f5;
            color: #6f42c1;
        }
        
        .stat-info h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .stat-info p {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Inventory Table */
        .inventory-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .table-header {
            background-color: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h2 {
            color: #1a3a8f;
            font-size: 1.5rem;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 500px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #1a3a8f;
            color: white;
            text-align: left;
            padding: 15px;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .category-header {
            background-color: #f1f5fd;
            font-weight: bold;
            color: #1a3a8f;
        }
        
        .item-code {
            font-weight: 600;
            color: #1a3a8f;
        }
        
        .numeric {
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        
        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-btn {
            background-color: #ffc107;
            color: #212529;
        }
        
        .delete-btn {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .history-btn {
            background-color: #17a2b8;
            color: white;
        }
        
        .stock-in {
            color: #28a745;
            font-weight: 600;
        }
        
        .stock-out {
            color: #dc3545;
            font-weight: 600;
        }
        
        /* History Filters */
        .history-filters {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }
        
        .filter-group input, .filter-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        /* History Table */
        .history-table-container {
            overflow-x: auto;
            max-height: 600px;
        }
        
        .history-type-in {
            color: #28a745;
            font-weight: 600;
        }
        
        .history-type-out {
            color: #dc3545;
            font-weight: 600;
        }
        
        .history-type-adjust {
            color: #ff9800;
            font-weight: 600;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            margin-top: 30px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            width: 90%;
            max-width: 800px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            animation: modalOpen 0.3s ease-out;
        }
        
        @keyframes modalOpen {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #1a3a8f 0%, #2c5aa0 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-body {
            padding: 25px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .form-col {
            flex: 1;
            min-width: 250px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #1a3a8f;
            box-shadow: 0 0 0 3px rgba(26, 58, 143, 0.1);
        }
        
        .modal-footer {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 0 0 10px 10px;
            text-align: right;
            border-top: 1px solid #eee;
        }
        
        /* Loading */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1a3a8f;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        /* Debug Panel */
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 0.8rem;
            display: none;
        }
        
        .debug-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 0.8rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .current-date {
                text-align: center;
            }
            
            .control-panel {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn-group {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .table-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            th, td {
                padding: 10px;
            }
            
            .status-info {
                flex-direction: column;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-bottom: none;
                border-left: 3px solid transparent;
            }
            
            .tab.active {
                border-bottom: none;
                border-left: 3px solid #1a3a8f;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div id="loadingText">Processing...</div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo-section">
                <div class="logo">
                    <i class="fas fa-boxes"></i>
                </div>
                <div>
                    <div class="company-name">Western Airducts Lanka (Pvt) Ltd</div>
                    <div class="company-subtitle">Inventory Management System with Stock History</div>
                </div>
            </div>
            <div class="current-date">
                <i class="far fa-calendar-alt"></i> Stock Balance as at <span id="currentDate">31.12.2025</span>
            </div>
        </div>
        
        <!-- Alert Container -->
        <div id="alertContainer"></div>
        
        <!-- Debug Panel -->
        <div class="debug-panel" id="debugPanel">
            <button class="debug-toggle" onclick="toggleDebug()">Hide Debug</button>
            <div id="debugContent"></div>
        </div>
        
        <!-- Status Panel -->
        <div class="status-panel">
            <h3><i class="fas fa-server"></i> System Status</h3>
            <div class="status-info">
                <div class="status-item">
                    <strong>Inventory File:</strong> <span id="inventoryFileStatus">Checking...</span>
                </div>
                <div class="status-item">
                    <strong>History File:</strong> <span id="historyFileStatus">Checking...</span>
                </div>
                <div class="status-item">
                    <strong>Total Items:</strong> <span id="fileItems">0</span>
                </div>
                <div class="status-item">
                    <strong>History Records:</strong> <span id="historyRecords">0</span>
                </div>
                <div class="status-item">
                    <strong>Last Updated:</strong> <span id="lastUpdated">Never</span>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="inventory">
                <i class="fas fa-boxes"></i> Inventory
            </div>
            <div class="tab" data-tab="history">
                <i class="fas fa-history"></i> Stock History
            </div>
            <div class="tab" data-tab="reports">
                <i class="fas fa-chart-bar"></i> Reports
            </div>
        </div>
        
        <!-- Inventory Tab -->
        <div id="inventoryTab" class="tab-content active">
            <!-- Control Panel -->
            <div class="control-panel">
                <div class="btn-group">
                    <button class="btn btn-primary" id="addItemBtn">
                        <i class="fas fa-plus-circle"></i> Add New Item
                    </button>
                    <button class="btn btn-success" id="saveBtn">
                        <i class="fas fa-save"></i> Save Inventory
                    </button>
                    <button class="btn btn-warning" id="loadBtn">
                        <i class="fas fa-sync-alt"></i> Reload Inventory
                    </button>
                    <button class="btn btn-info" id="stockAdjustmentBtn">
                        <i class="fas fa-exchange-alt"></i> Stock Adjustment
                    </button>
                </div>
                
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="Search items by code, description, or category...">
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-purple" id="exportBtn">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                    <button class="btn" id="importBtn" style="background-color: #6c757d; color: white;">
                        <i class="fas fa-file-import"></i> Import
                    </button>
                    <button class="btn" id="backupBtn" style="background-color: #9c27b0; color: white;">
                        <i class="fas fa-shield-alt"></i> Backup
                    </button>
                    <button class="btn" id="debugBtn" style="background-color: #ff5722; color: white;">
                        <i class="fas fa-bug"></i> Debug
                    </button>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalItems">0</h3>
                        <p>Total Items in Stock</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalValue">Rs 0.00</h3>
                        <p>Total Inventory Value</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="lowStockItems">0</h3>
                        <p>Low Stock Items (< 10 units)</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="categoriesCount">0</h3>
                        <p>Product Categories</p>
                    </div>
                </div>
            </div>
            
            <!-- Inventory Table -->
            <div class="inventory-container">
                <div class="table-header">
                    <h2><i class="fas fa-list-alt"></i> Inventory List</h2>
                    <div>
                        <span id="tableCount">Showing 0 items</span>
                    </div>
                </div>
                <div class="table-container">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Item Code</th>
                                <th>Description</th>
                                <th>Unit</th>
                                <th>Unit Price (Rs)</th>
                                <th>In</th>
                                <th>Out</th>
                                <th>Balance</th>
                                <th>Value (Rs)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- History Tab -->
        <div id="historyTab" class="tab-content">
            <!-- History Control Panel -->
            <div class="control-panel">
                <div class="btn-group">
                    <button class="btn btn-primary" id="viewAllHistoryBtn">
                        <i class="fas fa-list"></i> View All History
                    </button>
                    <button class="btn btn-success" id="refreshHistoryBtn">
                        <i class="fas fa-sync-alt"></i> Refresh History
                    </button>
                    <button class="btn btn-danger" id="clearHistoryBtn">
                        <i class="fas fa-trash"></i> Clear History
                    </button>
                </div>
                
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="historySearchInput" placeholder="Search history by item code, description, or reference...">
                </div>
            </div>
            
            <!-- History Stats -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalTransactions">0</h3>
                        <p>Total Transactions</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalStockIn">0</h3>
                        <p>Total Stock In</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon red">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalStockOut">0</h3>
                        <p>Total Stock Out</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="historyPeriod">-</h3>
                        <p>History Period</p>
                    </div>
                </div>
            </div>
            
            <!-- History Filters -->
            <div class="history-filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="historyItemCode">Item Code</label>
                        <select id="historyItemCode">
                            <option value="">All Items</option>
                            <!-- Item options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="historyType">Transaction Type</label>
                        <select id="historyType">
                            <option value="">All Types</option>
                            <option value="IN">Stock In</option>
                            <option value="OUT">Stock Out</option>
                            <option value="ADJUST">Adjustment</option>
                            <option value="NEW">New Item</option>
                            <option value="UPDATE">Update</option>
                            <option value="DELETE">Delete</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="historyStartDate">Start Date</label>
                        <input type="date" id="historyStartDate">
                    </div>
                    <div class="filter-group">
                        <label for="historyEndDate">End Date</label>
                        <input type="date" id="historyEndDate">
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-primary" id="applyHistoryFilters">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                        <button class="btn btn-warning" id="resetHistoryFilters">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- History Table -->
            <div class="inventory-container">
                <div class="table-header">
                    <h2><i class="fas fa-history"></i> Stock History</h2>
                    <div>
                        <span id="historyCount">Showing 0 transactions</span>
                    </div>
                </div>
                <div class="history-table-container">
                    <table id="historyTable">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Item Code</th>
                                <th>Description</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Previous Balance</th>
                                <th>New Balance</th>
                                <th>Reference</th>
                                <th>Notes</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <!-- History data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content">
            <!-- Reports Content -->
            <div class="control-panel">
                <h3><i class="fas fa-chart-bar"></i> Inventory Reports</h3>
            </div>
            
            <div class="stats-container">
                <div class="stat-card" onclick="generateStockReport()" style="cursor: pointer;">
                    <div class="stat-icon blue">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Stock Report</h3>
                        <p>Generate current stock report</p>
                    </div>
                </div>
                <div class="stat-card" onclick="generateLowStockReport()" style="cursor: pointer;">
                    <div class="stat-icon orange">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Low Stock</h3>
                        <p>Items with low stock levels</p>
                    </div>
                </div>
                <div class="stat-card" onclick="generateTransactionReport()" style="cursor: pointer;">
                    <div class="stat-icon green">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Transactions</h3>
                        <p>Transaction history report</p>
                    </div>
                </div>
                <div class="stat-card" onclick="generateValueReport()" style="cursor: pointer;">
                    <div class="stat-icon purple">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Value Analysis</h3>
                        <p>Inventory value analysis</p>
                    </div>
                </div>
            </div>
            
            <div class="inventory-container">
                <div class="table-header">
                    <h2><i class="fas fa-chart-pie"></i> Category-wise Summary</h2>
                </div>
                <div class="table-container">
                    <table id="categorySummaryTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Number of Items</th>
                                <th>Total Quantity</th>
                                <th>Total Value (Rs)</th>
                                <th>% of Total Value</th>
                            </tr>
                        </thead>
                        <tbody id="categorySummaryBody">
                            <!-- Category summary will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>Western Airducts Lanka (Pvt) Ltd &copy; <span id="currentYear">2025</span> | Inventory Management System v2.0 with History Tracking</p>
            <p>Data stored in JSON files: <strong>inventory_data.json</strong> and <strong>stock_history.json</strong></p>
        </div>
    </div>
    
    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Inventory Item</h2>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="no">No</label>
                                <input type="number" id="no">
                            </div>
                            <div class="form-group">
                                <label for="itemCode">Item Code *</label>
                                <input type="text" id="itemCode" required>
                            </div>
                            <div class="form-group">
                                <label for="description">Description *</label>
                                <input type="text" id="description" required>
                            </div>
                            <div class="form-group">
                                <label for="category">Category *</label>
                                <select id="category" required>
                                    <option value="">Select Category</option>
                                    <option value="ALLUMINIUM EGG CRATES">ALLUMINIUM EGG CRATES</option>
                                    <option value="ALLUMINIUM PROFILES">ALLUMINIUM PROFILES</option>
                                    <option value="G.I. COILS">G.I. COILS</option>
                                    <option value="G.I. SHEETS">G.I. SHEETS</option>
                                    <option value="SQUARE DUCT FLANGERS">SQUARE DUCT FLANGERS</option>
                                    <option value="SQUARE DUCT CORNERS">SQUARE DUCT CORNERS</option>
                                    <option value="SQUARE DUCT CLEATS">SQUARE DUCT CLEATS</option>
                                    <option value="GASKET TAPE">GASKET TAPE</option>
                                    <option value="OTHER MATERIAL">OTHER MATERIAL</option>
                                    <option value="V.C.D. WHEELS">V.C.D. WHEELS</option>
                                    <option value="POWDER COATING">POWDER COATING</option>
                                    <option value="STORES ITEMS">STORES ITEMS</option>
                                    <option value="DRILL BITS">DRILL BITS</option>
                                    <option value="POP RIVETS">POP RIVETS</option>
                                    <option value="UN PRINTED CARTONS">UN PRINTED CARTONS</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="unit">Unit *</label>
                                <input type="text" id="unit" required>
                            </div>
                            <div class="form-group">
                                <label for="unitPrice">Unit Price (Rs) *</label>
                                <input type="number" id="unitPrice" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="stockIn">Initial Stock In</label>
                                <input type="number" id="stockIn" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label for="stockOut">Initial Stock Out</label>
                                <input type="number" id="stockOut" step="0.01" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="balance">Initial Balance *</label>
                        <input type="number" id="balance" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes (Optional)</label>
                        <textarea id="notes" rows="3" placeholder="Additional information about this item"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" id="cancelBtn">Cancel</button>
                <button class="btn btn-primary" id="saveItemBtn">Save Item</button>
            </div>
        </div>
    </div>
    
    <!-- Stock Adjustment Modal -->
    <div id="stockAdjustmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-exchange-alt"></i> Stock Adjustment</h2>
                <button class="close-btn" id="closeAdjustmentModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="stockAdjustmentForm">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="adjustmentItem">Select Item *</label>
                                <select id="adjustmentItem" required>
                                    <option value="">Select an item</option>
                                    <!-- Item options will be populated dynamically -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="adjustmentType">Adjustment Type *</label>
                                <select id="adjustmentType" required>
                                    <option value="">Select type</option>
                                    <option value="IN">Stock In (Add)</option>
                                    <option value="OUT">Stock Out (Remove)</option>
                                    <option value="ADJUST">Adjust Balance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="adjustmentQuantity">Quantity *</label>
                                <input type="number" id="adjustmentQuantity" step="0.01" required min="0.01">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="adjustmentDate">Date *</label>
                                <input type="datetime-local" id="adjustmentDate" required>
                            </div>
                            <div class="form-group">
                                <label for="adjustmentReference">Reference No.</label>
                                <input type="text" id="adjustmentReference" placeholder="GRN No./Invoice No./etc.">
                            </div>
                            <div class="form-group">
                                <label>Current Stock</label>
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                    <div id="currentStockInfo">Select an item to see current stock</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="adjustmentNotes">Notes / Reason *</label>
                        <textarea id="adjustmentNotes" rows="3" required placeholder="Enter reason for adjustment (e.g., Purchase, Sales, Damage, Correction, etc.)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" id="cancelAdjustmentBtn">Cancel</button>
                <button class="btn btn-primary" id="saveAdjustmentBtn">Save Adjustment</button>
            </div>
        </div>
    </div>
    
    <!-- Item History Modal -->
    <div id="itemHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2><i class="fas fa-history"></i> Item Stock History</h2>
                <button class="close-btn" id="closeItemHistoryModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="itemHistoryInfo" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h3 id="itemHistoryTitle">Loading...</h3>
                    <div id="itemHistoryStats"></div>
                </div>
                <div class="table-container">
                    <table id="itemHistoryTable">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Previous</th>
                                <th>New</th>
                                <th>Reference</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="itemHistoryBody">
                            <!-- Item history will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="closeItemHistoryBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script>
        // ============================================
        // JAVASCRIPT FRONTEND WITH STOCK HISTORY
        // ============================================
        
        let inventoryData = [];
        let historyData = [];
        let editingItemId = null;
        let currentTab = 'inventory';
        
        // DOM elements
        const inventoryBody = document.getElementById('inventoryBody');
        const addItemBtn = document.getElementById('addItemBtn');
        const saveBtn = document.getElementById('saveBtn');
        const loadBtn = document.getElementById('loadBtn');
        const stockAdjustmentBtn = document.getElementById('stockAdjustmentBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const backupBtn = document.getElementById('backupBtn');
        const debugBtn = document.getElementById('debugBtn');
        const searchInput = document.getElementById('searchInput');
        const itemModal = document.getElementById('itemModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveItemBtn = document.getElementById('saveItemBtn');
        const itemForm = document.getElementById('itemForm');
        const modalTitle = document.getElementById('modalTitle');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const alertContainer = document.getElementById('alertContainer');
        const debugPanel = document.getElementById('debugPanel');
        const debugContent = document.getElementById('debugContent');
        
        // Tabs
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // History elements
        const viewAllHistoryBtn = document.getElementById('viewAllHistoryBtn');
        const refreshHistoryBtn = document.getElementById('refreshHistoryBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const historySearchInput = document.getElementById('historySearchInput');
        const historyBody = document.getElementById('historyBody');
        const historyItemCode = document.getElementById('historyItemCode');
        const historyType = document.getElementById('historyType');
        const historyStartDate = document.getElementById('historyStartDate');
        const historyEndDate = document.getElementById('historyEndDate');
        const applyHistoryFilters = document.getElementById('applyHistoryFilters');
        const resetHistoryFilters = document.getElementById('resetHistoryFilters');
        
        // Stock adjustment elements
        const stockAdjustmentModal = document.getElementById('stockAdjustmentModal');
        const closeAdjustmentModalBtn = document.getElementById('closeAdjustmentModalBtn');
        const cancelAdjustmentBtn = document.getElementById('cancelAdjustmentBtn');
        const saveAdjustmentBtn = document.getElementById('saveAdjustmentBtn');
        const adjustmentItem = document.getElementById('adjustmentItem');
        const adjustmentType = document.getElementById('adjustmentType');
        const adjustmentQuantity = document.getElementById('adjustmentQuantity');
        const adjustmentDate = document.getElementById('adjustmentDate');
        const adjustmentReference = document.getElementById('adjustmentReference');
        const adjustmentNotes = document.getElementById('adjustmentNotes');
        const currentStockInfo = document.getElementById('currentStockInfo');
        
        // Item history modal elements
        const itemHistoryModal = document.getElementById('itemHistoryModal');
        const closeItemHistoryModalBtn = document.getElementById('closeItemHistoryModalBtn');
        const closeItemHistoryBtn = document.getElementById('closeItemHistoryBtn');
        const itemHistoryTitle = document.getElementById('itemHistoryTitle');
        const itemHistoryStats = document.getElementById('itemHistoryStats');
        const itemHistoryBody = document.getElementById('itemHistoryBody');
        
        // Status elements
        const inventoryFileStatus = document.getElementById('inventoryFileStatus');
        const historyFileStatus = document.getElementById('historyFileStatus');
        const fileItems = document.getElementById('fileItems');
        const historyRecords = document.getElementById('historyRecords');
        const lastUpdated = document.getElementById('lastUpdated');
        
        // Stats elements
        const totalItemsEl = document.getElementById('totalItems');
        const totalValueEl = document.getElementById('totalValue');
        const lowStockItemsEl = document.getElementById('lowStockItems');
        const categoriesCountEl = document.getElementById('categoriesCount');
        const tableCountEl = document.getElementById('tableCount');
        const currentDateEl = document.getElementById('currentDate');
        const currentYearEl = document.getElementById('currentYear');
        
        // History stats elements
        const totalTransactionsEl = document.getElementById('totalTransactions');
        const totalStockInEl = document.getElementById('totalStockIn');
        const totalStockOutEl = document.getElementById('totalStockOut');
        const historyPeriodEl = document.getElementById('historyPeriod');
        const historyCountEl = document.getElementById('historyCount');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            currentDateEl.textContent = now.toLocaleDateString('en-GB');
            currentYearEl.textContent = now.getFullYear();
            
            // Set default dates for history filters
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            historyStartDate.valueAsDate = firstDay;
            historyEndDate.valueAsDate = today;
            
            // Set default adjustment date
            adjustmentDate.value = now.toISOString().slice(0, 16);
            
            // Event listeners
            addItemBtn.addEventListener('click', openAddItemModal);
            saveBtn.addEventListener('click', saveToJsonFile);
            loadBtn.addEventListener('click', loadFromJsonFile);
            stockAdjustmentBtn.addEventListener('click', openStockAdjustmentModal);
            exportBtn.addEventListener('click', exportData);
            importBtn.addEventListener('click', () => fileInput.click());
            backupBtn.addEventListener('click', createBackup);
            debugBtn.addEventListener('click', toggleDebug);
            searchInput.addEventListener('input', filterInventory);
            closeModalBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            saveItemBtn.addEventListener('click', saveItem);
            fileInput.addEventListener('change', handleFileImport);
            
            // History event listeners
            viewAllHistoryBtn.addEventListener('click', loadHistoryData);
            refreshHistoryBtn.addEventListener('click', loadHistoryData);
            clearHistoryBtn.addEventListener('click', clearHistory);
            historySearchInput.addEventListener('input', filterHistory);
            applyHistoryFilters.addEventListener('click', applyHistoryFilter);
            resetHistoryFilters.addEventListener('click', resetHistoryFilter);
            
            // Stock adjustment event listeners
            closeAdjustmentModalBtn.addEventListener('click', closeStockAdjustmentModal);
            cancelAdjustmentBtn.addEventListener('click', closeStockAdjustmentModal);
            saveAdjustmentBtn.addEventListener('click', saveStockAdjustment);
            adjustmentItem.addEventListener('change', updateCurrentStockInfo);
            adjustmentType.addEventListener('change', updateAdjustmentType);
            
            // Item history modal event listeners
            closeItemHistoryModalBtn.addEventListener('click', closeItemHistoryModal);
            closeItemHistoryBtn.addEventListener('click', closeItemHistoryModal);
            
            // Tab event listeners
            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === itemModal) closeModal();
                if (event.target === stockAdjustmentModal) closeStockAdjustmentModal();
                if (event.target === itemHistoryModal) closeItemHistoryModal();
            });
            
            // Load data on startup
            loadFromJsonFile();
            loadHistoryData();
            checkFileStatus();
        });
        
        // Show loading
        function showLoading(message) {
            loadingText.textContent = message;
            loading.style.display = 'flex';
        }
        
        // Hide loading
        function hideLoading() {
            loading.style.display = 'none';
        }
        
        // Show alert
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;
            
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }
        
        // Toggle debug panel
        function toggleDebug() {
            debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
            if (debugPanel.style.display === 'block') {
                debugBtn.innerHTML = '<i class="fas fa-bug"></i> Hide Debug';
                runDebugCheck();
            } else {
                debugBtn.innerHTML = '<i class="fas fa-bug"></i> Debug';
            }
        }
        
        // Run debug check
        async function runDebugCheck() {
            debugContent.innerHTML = '<p>Running debug checks...</p>';
            
            try {
                const response = await fetch('?action=check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });
                
                const result = await response.json();
                debugContent.innerHTML = `
                    <h4>System Status:</h4>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                    <h4>Current Inventory Data (first 3 items):</h4>
                    <pre>${JSON.stringify(inventoryData.slice(0, 3), null, 2)}</pre>
                    <h4>Current History Data (first 3 transactions):</h4>
                    <pre>${JSON.stringify(historyData.slice(0, 3), null, 2)}</pre>
                    <p>Total inventory items: ${inventoryData.length}</p>
                    <p>Total history transactions: ${historyData.length}</p>
                `;
            } catch (error) {
                debugContent.innerHTML = `<p>Debug error: ${error.message}</p>`;
            }
        }
        
        // Check file status
        async function checkFileStatus() {
            try {
                const response = await fetch('?action=check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const status = result.results;
                    
                    if (status.inventory.exists) {
                        inventoryFileStatus.innerHTML = `<span style="color: #2e7d32;"> ${formatBytes(status.inventory.size)}</span>`;
                    } else {
                        inventoryFileStatus.innerHTML = `<span style="color: #dc3545;"> Not found</span>`;
                    }
                    
                    if (status.history.exists) {
                        historyFileStatus.innerHTML = `<span style="color: #2e7d32;"> ${formatBytes(status.history.size)}</span>`;
                    } else {
                        historyFileStatus.innerHTML = `<span style="color: #dc3545;"> Not found</span>`;
                    }
                } else {
                    inventoryFileStatus.innerHTML = `<span style="color: #dc3545;"> Error</span>`;
                    historyFileStatus.innerHTML = `<span style="color: #dc3545;"> Error</span>`;
                }
            } catch (error) {
                inventoryFileStatus.innerHTML = `<span style="color: #dc3545;"> Error</span>`;
                historyFileStatus.innerHTML = `<span style="color: #dc3545;"> Error</span>`;
            }
        }
        
        // Format bytes
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Switch tabs
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update active tab
            tabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Show active tab content
            tabContents.forEach(content => {
                if (content.id === tabName + 'Tab') {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // Load data if needed
            if (tabName === 'history' && historyData.length === 0) {
                loadHistoryData();
            } else if (tabName === 'reports') {
                generateCategorySummary();
            }
        }
        
        // Load data from JSON file on server
        async function loadFromJsonFile() {
            showLoading('Loading inventory data...');
            
            try {
                const response = await fetch('?action=load', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    inventoryData = result.data || [];
                    renderInventory();
                    updateStats();
                    
                    // Update item dropdowns
                    updateItemDropdowns();
                    
                    // Update file status
                    fileItems.textContent = inventoryData.length;
                    lastUpdated.textContent = new Date().toLocaleTimeString();
                    
                    showAlert(`Successfully loaded ${inventoryData.length} inventory items`, 'success');
                    
                    // Update debug panel if open
                    if (debugPanel.style.display === 'block') {
                        runDebugCheck();
                    }
                } else {
                    throw new Error(result.message || 'Failed to load inventory data');
                }
            } catch (error) {
                showAlert(`Error loading inventory: ${error.message}`, 'error');
                console.error('Load error:', error);
            } finally {
                hideLoading();
                checkFileStatus();
            }
        }
        
        // Save data to JSON file on server
        async function saveToJsonFile() {
            if (inventoryData.length === 0) {
                showAlert('No inventory data to save!', 'warning');
                return;
            }
            
            showLoading('Saving inventory data...');
            
            try {
                const response = await fetch('?action=save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        data: inventoryData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Inventory saved successfully! ${result.total_items} items saved.`, 'success');
                    
                    // Update status
                    fileItems.textContent = inventoryData.length;
                    lastUpdated.textContent = new Date().toLocaleString();
                    
                    // Update debug panel if open
                    if (debugPanel.style.display === 'block') {
                        runDebugCheck();
                    }
                } else {
                    throw new Error(result.message || 'Failed to save inventory data');
                }
            } catch (error) {
                showAlert(`Error saving inventory: ${error.message}`, 'error');
                console.error('Save error:', error);
            } finally {
                hideLoading();
            }
        }
        
        // Load history data
        async function loadHistoryData() {
            showLoading('Loading stock history...');
            
            try {
                const response = await fetch('?action=load_history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    historyData = result.data || [];
                    renderHistory();
                    updateHistoryStats();
                    
                    // Update status
                    historyRecords.textContent = historyData.length;
                    
                    showAlert(`Loaded ${historyData.length} history records`, 'success');
                    
                    // Update debug panel if open
                    if (debugPanel.style.display === 'block') {
                        runDebugCheck();
                    }
                } else {
                    throw new Error(result.message || 'Failed to load history data');
                }
            } catch (error) {
                showAlert(`Error loading history: ${error.message}`, 'error');
                console.error('History load error:', error);
            } finally {
                hideLoading();
            }
        }
        
        // Save history transaction
        async function saveHistoryTransaction(transaction) {
            try {
                const response = await fetch('?action=save_history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        transactions: [transaction]
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Reload history data
                    await loadHistoryData();
                    return true;
                } else {
                    throw new Error(result.message || 'Failed to save history');
                }
            } catch (error) {
                showAlert(`Error saving history: ${error.message}`, 'error');
                console.error('History save error:', error);
                return false;
            }
        }
        
        // Clear history
        async function clearHistory() {
            if (!confirm('Are you sure you want to clear ALL history records? This action cannot be undone.')) {
                return;
            }
            
            showLoading('Clearing history...');
            
            try {
                // Create a backup before clearing
                await createBackup();
                
                // Clear history by saving empty array
                const response = await fetch('?action=save_history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        transactions: []
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    historyData = [];
                    renderHistory();
                    updateHistoryStats();
                    showAlert('History cleared successfully', 'success');
                } else {
                    throw new Error(result.message || 'Failed to clear history');
                }
            } catch (error) {
                showAlert(`Error clearing history: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Create backup
        async function createBackup() {
            showLoading('Creating backup...');
            
            try {
                const response = await fetch('?action=backup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = 'Backup created successfully!';
                    if (result.backups && result.backups.length > 0) {
                        message += ` Files: ${result.backups.map(b => b.type).join(', ')}`;
                    }
                    showAlert(message, 'success');
                } else {
                    throw new Error(result.message || 'Failed to create backup');
                }
            } catch (error) {
                showAlert(`Error creating backup: ${error.message}`, 'error');
                console.error('Backup error:', error);
            } finally {
                hideLoading();
            }
        }
        
        // Export data
        function exportData() {
            if (inventoryData.length === 0) {
                showAlert('No data to export!', 'warning');
                return;
            }
            
            // Export both inventory and history
            const exportData = {
                inventory: {
                    company: "Western Airducts Lanka (Pvt) Ltd",
                    reportTitle: "Stock balance as at " + document.getElementById('currentDate').textContent,
                    items: inventoryData.map(item => ({
                        itemCode: item.itemCode || '',
                        no: item.no || item.id || null,
                        description: item.description || '',
                        unit: item.unit || '',
                        unitPrice: item.unitPrice || 0,
                        in: item.stockIn || 0,
                        out: item.stockOut || 0,
                        balance: item.balance || 0,
                        value: item.value || 0
                    })),
                    metadata: {
                        exported: new Date().toISOString(),
                        totalItems: inventoryData.length,
                        totalValue: inventoryData.reduce((sum, item) => sum + (item.value || 0), 0)
                    }
                },
                history: {
                    transactions: historyData,
                    metadata: {
                        exported: new Date().toISOString(),
                        totalTransactions: historyData.length
                    }
                }
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
            link.download = `inventory_full_backup_${timestamp}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert('Full data exported successfully!', 'success');
        }
        
        // Import JSON file
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    let importedItems = [];
                    if (Array.isArray(importedData)) {
                        importedItems = importedData;
                    } else if (importedData.items && Array.isArray(importedData.items)) {
                        // Convert backend format to frontend format
                        importedItems = importedData.items.map(item => ({
                            id: item.no || null,
                            itemCode: item.itemCode || '',
                            no: item.no || null,
                            description: item.description || '',
                            unit: item.unit || '',
                            unitPrice: item.unitPrice || 0,
                            stockIn: item.in || 0,
                            stockOut: item.out || 0,
                            balance: item.balance || 0,
                            value: item.value || 0,
                            category: determineCategoryFrontend(item.itemCode),
                            notes: ''
                        }));
                    } else if (importedData.inventory && importedData.inventory.items && Array.isArray(importedData.inventory.items)) {
                        importedItems = importedData.inventory.items.map(item => ({
                            id: item.no || null,
                            itemCode: item.itemCode || '',
                            no: item.no || null,
                            description: item.description || '',
                            unit: item.unit || '',
                            unitPrice: item.unitPrice || 0,
                            stockIn: item.in || 0,
                            stockOut: item.out || 0,
                            balance: item.balance || 0,
                            value: item.value || 0,
                            category: determineCategoryFrontend(item.itemCode),
                            notes: ''
                        }));
                    } else if (importedData.inventory && Array.isArray(importedData.inventory)) {
                        importedItems = importedData.inventory;
                    } else {
                        throw new Error('Invalid JSON format');
                    }
                    
                    const action = confirm(`Found ${importedItems.length} items. Replace existing data (OK) or merge (Cancel)?`);
                    
                    if (action) {
                        inventoryData = importedItems;
                        showAlert(`Replaced with ${importedItems.length} imported items`, 'success');
                    } else {
                        const existingIds = new Set(inventoryData.map(item => item.id));
                        let newItems = 0;
                        
                        importedItems.forEach(item => {
                            if (!existingIds.has(item.id)) {
                                inventoryData.push(item);
                                newItems++;
                            }
                        });
                        
                        showAlert(`Merged ${newItems} new items`, 'success');
                    }
                    
                    renderInventory();
                    updateStats();
                    updateItemDropdowns();
                    
                } catch (error) {
                    showAlert('Error importing file. Invalid format.', 'error');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file);
            fileInput.value = '';
        }
        
        // Determine category from item code (frontend version)
        function determineCategoryFrontend(itemCode) {
            const categoryMap = {
                'WAD - OS': 'ALLUMINIUM EGG CRATES',
                'WAD -AP': 'ALLUMINIUM PROFILES',
                'WAD - GC': 'G.I. COILS',
                'WAD - GS': 'G.I. SHEETS',
                'WAD - OS -': 'ALLUMINIUM EGG CRATES',
                'WAD - MR': 'ALLUMINIUM EGG CRATES',
                'WAD - SD': 'SQUARE DUCT FLANGERS',
                'WAD - DW': 'V.C.D. WHEELS',
                'WAD - PC': 'POWDER COATING',
                'WAD - SI': 'STORES ITEMS',
                'WAD - DB': 'DRILL BITS',
                'WAD - PR': 'POP RIVETS',
                'WAD - UP': 'UN PRINTED CARTONS',
                'WAD - OM': 'OTHER MATERIAL'
            };
            
            for (const prefix in categoryMap) {
                if (itemCode && itemCode.startsWith(prefix)) {
                    return categoryMap[prefix];
                }
            }
            
            return 'OTHER MATERIAL';
        }
        
        // Render inventory table
        function renderInventory(data = inventoryData) {
            inventoryBody.innerHTML = '';
            
            if (data.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="10" style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                        <h3>No inventory items found</h3>
                        <p>Add your first item or load data from JSON file.</p>
                    </td>
                `;
                inventoryBody.appendChild(emptyRow);
                tableCountEl.textContent = `Showing 0 items`;
                return;
            }
            
            let currentCategory = '';
            let itemCount = 0;
            
            data.forEach(item => {
                if (item.category !== currentCategory) {
                    currentCategory = item.category;
                    const categoryRow = document.createElement('tr');
                    categoryRow.className = 'category-header';
                    categoryRow.innerHTML = `<td colspan="10">${currentCategory}</td>`;
                    inventoryBody.appendChild(categoryRow);
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.no || item.id}</td>
                    <td class="item-code">${item.itemCode}</td>
                    <td>${item.description}</td>
                    <td>${item.unit}</td>
                    <td class="numeric">${formatCurrency(item.unitPrice)}</td>
                    <td class="numeric stock-in">${item.stockIn > 0 ? item.stockIn : '-'}</td>
                    <td class="numeric stock-out">${item.stockOut > 0 ? item.stockOut : '-'}</td>
                    <td class="numeric">${item.balance}</td>
                    <td class="numeric">${formatCurrency(item.value)}</td>
                    <td>
                        <div class="actions">
                            <button class="action-btn edit-btn" data-id="${item.id}" title="Edit Item">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn history-btn" data-id="${item.id}" data-itemcode="${item.itemCode}" title="View History">
                                <i class="fas fa-history"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${item.id}" title="Delete Item">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                inventoryBody.appendChild(row);
                itemCount++;
            });
            
            tableCountEl.textContent = `Showing ${itemCount} items`;
            
            // Add event listeners
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    openEditItemModal(id);
                });
            });
            
            document.querySelectorAll('.history-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    const itemCode = this.getAttribute('data-itemcode');
                    viewItemHistory(id, itemCode);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteItem(id);
                });
            });
        }
        
        // Render history table
        function renderHistory(data = historyData) {
            historyBody.innerHTML = '';
            
            if (data.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="10" style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-history" style="font-size: 3rem; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                        <h3>No history records found</h3>
                        <p>Perform stock adjustments or modify items to create history records.</p>
                    </td>
                `;
                historyBody.appendChild(emptyRow);
                historyCountEl.textContent = `Showing 0 transactions`;
                return;
            }
            
            let itemCount = 0;
            
            data.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Determine type class and display text
                let typeClass = '';
                let typeText = '';
                switch(transaction.type) {
                    case 'IN':
                        typeClass = 'history-type-in';
                        typeText = 'Stock In';
                        break;
                    case 'OUT':
                        typeClass = 'history-type-out';
                        typeText = 'Stock Out';
                        break;
                    case 'ADJUST':
                        typeClass = 'history-type-adjust';
                        typeText = 'Adjustment';
                        break;
                    case 'NEW':
                        typeText = 'New Item';
                        break;
                    case 'UPDATE':
                        typeText = 'Updated';
                        break;
                    case 'DELETE':
                        typeText = 'Deleted';
                        break;
                    default:
                        typeText = transaction.type;
                }
                
                row.innerHTML = `
                    <td>${formatDateTime(transaction.date)}</td>
                    <td class="item-code">${transaction.itemCode}</td>
                    <td>${transaction.description}</td>
                    <td class="${typeClass}">${typeText}</td>
                    <td class="numeric">${transaction.quantity !== undefined ? transaction.quantity : '-'}</td>
                    <td class="numeric">${transaction.previousBalance !== undefined ? transaction.previousBalance : '-'}</td>
                    <td class="numeric">${transaction.newBalance !== undefined ? transaction.newBalance : '-'}</td>
                    <td>${transaction.reference || '-'}</td>
                    <td>${transaction.notes || '-'}</td>
                    <td>${transaction.user || 'System'}</td>
                `;
                historyBody.appendChild(row);
                itemCount++;
            });
            
            historyCountEl.textContent = `Showing ${itemCount} transactions`;
        }
        
        // Update statistics
        function updateStats() {
            const totalItems = inventoryData.length;
            const totalValue = inventoryData.reduce((sum, item) => sum + (item.value || 0), 0);
            const lowStockItems = inventoryData.filter(item => item.balance < 10 && item.balance > 0).length;
            const categories = [...new Set(inventoryData.map(item => item.category).filter(Boolean))].length;
            
            totalItemsEl.textContent = totalItems.toLocaleString();
            totalValueEl.textContent = `Rs ${formatCurrency(totalValue)}`;
            lowStockItemsEl.textContent = lowStockItems.toLocaleString();
            categoriesCountEl.textContent = categories.toLocaleString();
        }
        
        // Update history statistics
        function updateHistoryStats() {
            const totalTransactions = historyData.length;
            
            // Calculate totals
            const stockInTotal = historyData
                .filter(t => t.type === 'IN')
                .reduce((sum, t) => sum + (t.quantity || 0), 0);
            
            const stockOutTotal = historyData
                .filter(t => t.type === 'OUT')
                .reduce((sum, t) => sum + (t.quantity || 0), 0);
            
            // Calculate date range
            let oldestDate = null;
            let newestDate = null;
            
            if (historyData.length > 0) {
                const dates = historyData.map(t => new Date(t.date));
                oldestDate = new Date(Math.min(...dates));
                newestDate = new Date(Math.max(...dates));
            }
            
            totalTransactionsEl.textContent = totalTransactions.toLocaleString();
            totalStockInEl.textContent = stockInTotal.toLocaleString();
            totalStockOutEl.textContent = stockOutTotal.toLocaleString();
            
            if (oldestDate && newestDate) {
                const period = `${oldestDate.toLocaleDateString()} - ${newestDate.toLocaleDateString()}`;
                historyPeriodEl.textContent = period;
            } else {
                historyPeriodEl.textContent = '-';
            }
        }
        
        // Format currency
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '0.00';
            return amount.toLocaleString('en-LK', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // Format date and time
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-LK', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Open add item modal
        function openAddItemModal() {
            editingItemId = null;
            modalTitle.textContent = "Add New Inventory Item";
            itemForm.reset();
            document.getElementById('balance').value = 0;
            document.getElementById('stockIn').value = 0;
            document.getElementById('stockOut').value = 0;
            
            // Auto-generate the next item number
            if (inventoryData.length > 0) {
                const maxNo = Math.max(...inventoryData.map(item => item.no || item.id).filter(n => n !== null));
                document.getElementById('no').value = maxNo + 1;
            } else {
                document.getElementById('no').value = 1;
            }
            
            itemModal.style.display = 'block';
        }
        
        // Open edit item modal
        function openEditItemModal(id) {
            const item = inventoryData.find(item => item.id === id);
            if (!item) return;
            
            editingItemId = id;
            modalTitle.textContent = "Edit Inventory Item";
            
            document.getElementById('no').value = item.no || item.id;
            document.getElementById('itemCode').value = item.itemCode;
            document.getElementById('description').value = item.description;
            document.getElementById('category').value = item.category;
            document.getElementById('unit').value = item.unit;
            document.getElementById('unitPrice').value = item.unitPrice;
            document.getElementById('stockIn').value = item.stockIn;
            document.getElementById('stockOut').value = item.stockOut;
            document.getElementById('balance').value = item.balance;
            document.getElementById('notes').value = item.notes || '';
            
            itemModal.style.display = 'block';
        }
        
        // Close modal
        function closeModal() {
            itemModal.style.display = 'none';
            editingItemId = null;
        }
        
        // Save item
        async function saveItem() {
            const no = document.getElementById('no').value ? parseInt(document.getElementById('no').value) : null;
            const itemCode = document.getElementById('itemCode').value.trim();
            const description = document.getElementById('description').value.trim();
            const category = document.getElementById('category').value;
            const unit = document.getElementById('unit').value.trim();
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            const stockIn = parseFloat(document.getElementById('stockIn').value) || 0;
            const stockOut = parseFloat(document.getElementById('stockOut').value) || 0;
            const balance = parseFloat(document.getElementById('balance').value) || 0;
            const notes = document.getElementById('notes').value.trim();
            
            if (!itemCode || !description || !category || !unit) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            const value = unitPrice * balance;
            
            let historyTransaction = null;
            
            if (editingItemId !== null) {
                // Update existing item
                const index = inventoryData.findIndex(item => item.id === editingItemId);
                if (index !== -1) {
                    const oldItem = inventoryData[index];
                    
                    // Create history record for update
                    historyTransaction = {
                        date: new Date().toISOString(),
                        itemCode: itemCode,
                        description: description,
                        type: 'UPDATE',
                        previousBalance: oldItem.balance,
                        newBalance: balance,
                        quantity: balance - oldItem.balance,
                        notes: `Item updated: ${notes || 'No notes'}`,
                        user: 'Admin'
                    };
                    
                    inventoryData[index] = {
                        ...oldItem,
                        no: no || oldItem.no,
                        itemCode,
                        description,
                        category,
                        unit,
                        unitPrice,
                        stockIn,
                        stockOut,
                        balance,
                        value,
                        notes
                    };
                    showAlert('Item updated successfully!', 'success');
                }
            } else {
                // Add new item
                const newId = inventoryData.length > 0 ? Math.max(...inventoryData.map(item => item.id)) + 1 : 1;
                const newItem = {
                    id: newId,
                    no: no || newId,
                    itemCode,
                    description,
                    category,
                    unit,
                    unitPrice,
                    stockIn,
                    stockOut,
                    balance,
                    value,
                    notes
                };
                
                inventoryData.push(newItem);
                
                // Create history record for new item
                historyTransaction = {
                    date: new Date().toISOString(),
                    itemCode: itemCode,
                    description: description,
                    type: 'NEW',
                    previousBalance: 0,
                    newBalance: balance,
                    quantity: balance,
                    notes: `New item added: ${notes || 'No notes'}`,
                    user: 'Admin'
                };
                
                showAlert('Item added successfully!', 'success');
            }
            
            // Save history transaction if exists
            if (historyTransaction) {
                await saveHistoryTransaction(historyTransaction);
            }
            
            renderInventory();
            updateStats();
            updateItemDropdowns();
            closeModal();
        }
        
        // Delete item
        async function deleteItem(id) {
            if (!confirm('Are you sure you want to delete this item? This action cannot be undone.')) return;
            
            const item = inventoryData.find(item => item.id === id);
            if (!item) return;
            
            // Create history record for deletion
            const historyTransaction = {
                date: new Date().toISOString(),
                itemCode: item.itemCode,
                description: item.description,
                type: 'DELETE',
                previousBalance: item.balance,
                newBalance: 0,
                quantity: -item.balance,
                notes: 'Item deleted from inventory',
                user: 'Admin'
            };
            
            // Remove item from inventory
            inventoryData = inventoryData.filter(item => item.id !== id);
            
            // Save history
            await saveHistoryTransaction(historyTransaction);
            
            renderInventory();
            updateStats();
            updateItemDropdowns();
            showAlert('Item deleted successfully!', 'success');
        }
        
        // Filter inventory
        function filterInventory() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderInventory();
                return;
            }
            
            const filteredData = inventoryData.filter(item => 
                (item.itemCode && item.itemCode.toLowerCase().includes(searchTerm)) ||
                (item.description && item.description.toLowerCase().includes(searchTerm)) ||
                (item.category && item.category.toLowerCase().includes(searchTerm))
            );
            
            renderInventory(filteredData);
        }
        
        // Filter history
        function filterHistory() {
            const searchTerm = historySearchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderHistory();
                return;
            }
            
            const filteredData = historyData.filter(transaction => 
                (transaction.itemCode && transaction.itemCode.toLowerCase().includes(searchTerm)) ||
                (transaction.description && transaction.description.toLowerCase().includes(searchTerm)) ||
                (transaction.reference && transaction.reference.toLowerCase().includes(searchTerm)) ||
                (transaction.notes && transaction.notes.toLowerCase().includes(searchTerm))
            );
            
            renderHistory(filteredData);
        }
        
        // Apply history filter
        async function applyHistoryFilter() {
            showLoading('Filtering history...');
            
            try {
                let url = '?action=get_item_history';
                
                // Build query parameters
                const params = [];
                
                if (historyItemCode.value) {
                    params.push(`itemCode=${encodeURIComponent(historyItemCode.value)}`);
                }
                
                if (historyType.value) {
                    params.push(`type=${encodeURIComponent(historyType.value)}`);
                }
                
                if (historyStartDate.value) {
                    params.push(`startDate=${encodeURIComponent(historyStartDate.value)}`);
                }
                
                if (historyEndDate.value) {
                    params.push(`endDate=${encodeURIComponent(historyEndDate.value)}`);
                }
                
                if (params.length > 0) {
                    url += '&' + params.join('&');
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    renderHistory(result.data);
                    historyCountEl.textContent = `Showing ${result.total} filtered transactions`;
                    showAlert(`Found ${result.total} transactions matching filters`, 'success');
                } else {
                    throw new Error(result.message || 'Failed to filter history');
                }
            } catch (error) {
                showAlert(`Error filtering history: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Reset history filter
        function resetHistoryFilter() {
            historyItemCode.value = '';
            historyType.value = '';
            
            // Reset to current month
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            historyStartDate.valueAsDate = firstDay;
            historyEndDate.valueAsDate = today;
            
            // Reload all history
            loadHistoryData();
        }
        
        // Update item dropdowns
        function updateItemDropdowns() {
            // Update adjustment item dropdown
            adjustmentItem.innerHTML = '<option value="">Select an item</option>';
            inventoryData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.itemCode} - ${item.description}`;
                option.setAttribute('data-balance', item.balance);
                option.setAttribute('data-unit', item.unit);
                adjustmentItem.appendChild(option);
            });
            
            // Update history item filter dropdown
            historyItemCode.innerHTML = '<option value="">All Items</option>';
            const uniqueItems = [...new Set(inventoryData.map(item => item.itemCode))];
            uniqueItems.forEach(itemCode => {
                const option = document.createElement('option');
                option.value = itemCode;
                option.textContent = itemCode;
                historyItemCode.appendChild(option);
            });
        }
        
        // Open stock adjustment modal
        function openStockAdjustmentModal() {
            if (inventoryData.length === 0) {
                showAlert('No items available for adjustment. Please add items first.', 'warning');
                return;
            }
            
            // Reset form
            document.getElementById('stockAdjustmentForm').reset();
            adjustmentDate.value = new Date().toISOString().slice(0, 16);
            currentStockInfo.innerHTML = 'Select an item to see current stock';
            
            stockAdjustmentModal.style.display = 'block';
        }
        
        // Close stock adjustment modal
        function closeStockAdjustmentModal() {
            stockAdjustmentModal.style.display = 'none';
        }
        
        // Update current stock info
        function updateCurrentStockInfo() {
            const selectedId = adjustmentItem.value;
            if (!selectedId) {
                currentStockInfo.innerHTML = 'Select an item to see current stock';
                return;
            }
            
            const item = inventoryData.find(item => item.id == selectedId);
            if (item) {
                currentStockInfo.innerHTML = `
                    <strong>Current Balance:</strong> ${item.balance} ${item.unit}<br>
                    <strong>Unit Price:</strong> Rs ${formatCurrency(item.unitPrice)}<br>
                    <strong>Current Value:</strong> Rs ${formatCurrency(item.value)}
                `;
            }
        }
        
        // Update adjustment type
        function updateAdjustmentType() {
            const type = adjustmentType.value;
            const quantityInput = adjustmentQuantity;
            
            if (type === 'ADJUST') {
                quantityInput.placeholder = "Enter new balance";
            } else if (type === 'IN') {
                quantityInput.placeholder = "Enter quantity to add";
            } else if (type === 'OUT') {
                quantityInput.placeholder = "Enter quantity to remove";
            }
        }
        
        // Save stock adjustment
        async function saveStockAdjustment() {
            const itemId = adjustmentItem.value;
            const type = adjustmentType.value;
            const quantity = parseFloat(adjustmentQuantity.value);
            const date = adjustmentDate.value;
            const reference = adjustmentReference.value.trim();
            const notes = adjustmentNotes.value.trim();
            
            // Validation
            if (!itemId || !type || !quantity || quantity <= 0 || !date || !notes) {
                showAlert('Please fill in all required fields correctly', 'error');
                return;
            }
            
            const item = inventoryData.find(item => item.id == itemId);
            if (!item) {
                showAlert('Selected item not found', 'error');
                return;
            }
            
            // Calculate new balance
            let newBalance = item.balance;
            let adjustmentQuantity = quantity;
            
            if (type === 'IN') {
                newBalance += quantity;
            } else if (type === 'OUT') {
                if (quantity > item.balance) {
                    showAlert(`Cannot remove ${quantity} units. Only ${item.balance} units available.`, 'error');
                    return;
                }
                newBalance -= quantity;
            } else if (type === 'ADJUST') {
                adjustmentQuantity = quantity - item.balance;
                newBalance = quantity;
            }
            
            // Update item
            const oldBalance = item.balance;
            item.balance = newBalance;
            item.value = item.unitPrice * newBalance;
            
            // Update stock in/out based on type
            if (type === 'IN') {
                item.stockIn = (item.stockIn || 0) + quantity;
            } else if (type === 'OUT') {
                item.stockOut = (item.stockOut || 0) + quantity;
            }
            
            // Create history transaction
            const historyTransaction = {
                date: date,
                itemCode: item.itemCode,
                description: item.description,
                type: type,
                previousBalance: oldBalance,
                newBalance: newBalance,
                quantity: adjustmentQuantity,
                reference: reference,
                notes: notes,
                user: 'Admin'
            };
            
            // Save inventory and history
            await saveToJsonFile();
            await saveHistoryTransaction(historyTransaction);
            
            // Update UI
            renderInventory();
            updateStats();
            updateCurrentStockInfo();
            
            showAlert(`Stock adjustment saved successfully! New balance: ${newBalance} ${item.unit}`, 'success');
            closeStockAdjustmentModal();
        }
        
        // View item history
        async function viewItemHistory(id, itemCode) {
            const item = inventoryData.find(item => item.id === id);
            if (!item) return;
            
            showLoading('Loading item history...');
            
            try {
                const response = await fetch(`?action=get_item_history&itemCode=${encodeURIComponent(itemCode)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update modal title and info
                    itemHistoryTitle.textContent = `${item.itemCode} - ${item.description}`;
                    
                    // Calculate stats
                    const itemHistory = result.data;
                    const totalTransactions = itemHistory.length;
                    const stockInTotal = itemHistory.filter(t => t.type === 'IN').reduce((sum, t) => sum + (t.quantity || 0), 0);
                    const stockOutTotal = itemHistory.filter(t => t.type === 'OUT').reduce((sum, t) => sum + (t.quantity || 0), 0);
                    
                    itemHistoryStats.innerHTML = `
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div><strong>Current Stock:</strong> ${item.balance} ${item.unit}</div>
                            <div><strong>Total Transactions:</strong> ${totalTransactions}</div>
                            <div><strong>Total Stock In:</strong> ${stockInTotal} ${item.unit}</div>
                            <div><strong>Total Stock Out:</strong> ${stockOutTotal} ${item.unit}</div>
                        </div>
                    `;
                    
                    // Render history table
                    itemHistoryBody.innerHTML = '';
                    
                    if (itemHistory.length === 0) {
                        itemHistoryBody.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
                                    No history records found for this item.
                                </td>
                            </tr>
                        `;
                    } else {
                        itemHistory.forEach(transaction => {
                            const row = document.createElement('tr');
                            
                            // Determine type class and display text
                            let typeClass = '';
                            let typeText = '';
                            switch(transaction.type) {
                                case 'IN':
                                    typeClass = 'history-type-in';
                                    typeText = 'Stock In';
                                    break;
                                case 'OUT':
                                    typeClass = 'history-type-out';
                                    typeText = 'Stock Out';
                                    break;
                                case 'ADJUST':
                                    typeClass = 'history-type-adjust';
                                    typeText = 'Adjustment';
                                    break;
                                case 'NEW':
                                    typeText = 'New Item';
                                    break;
                                case 'UPDATE':
                                    typeText = 'Updated';
                                    break;
                                case 'DELETE':
                                    typeText = 'Deleted';
                                    break;
                                default:
                                    typeText = transaction.type;
                            }
                            
                            row.innerHTML = `
                                <td>${formatDateTime(transaction.date)}</td>
                                <td class="${typeClass}">${typeText}</td>
                                <td class="numeric">${transaction.quantity !== undefined ? transaction.quantity : '-'}</td>
                                <td class="numeric">${transaction.previousBalance !== undefined ? transaction.previousBalance : '-'}</td>
                                <td class="numeric">${transaction.newBalance !== undefined ? transaction.newBalance : '-'}</td>
                                <td>${transaction.reference || '-'}</td>
                                <td>${transaction.notes || '-'}</td>
                            `;
                            itemHistoryBody.appendChild(row);
                        });
                    }
                    
                    // Show modal
                    itemHistoryModal.style.display = 'block';
                    
                } else {
                    throw new Error(result.message || 'Failed to load item history');
                }
            } catch (error) {
                showAlert(`Error loading item history: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Close item history modal
        function closeItemHistoryModal() {
            itemHistoryModal.style.display = 'none';
        }
        
        // Generate category summary for reports
        function generateCategorySummary() {
            const categoryBody = document.getElementById('categorySummaryBody');
            categoryBody.innerHTML = '';
            
            if (inventoryData.length === 0) {
                categoryBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                            No inventory data available for reports.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Group items by category
            const categoryGroups = {};
            inventoryData.forEach(item => {
                const category = item.category || 'Uncategorized';
                if (!categoryGroups[category]) {
                    categoryGroups[category] = {
                        items: 0,
                        quantity: 0,
                        value: 0
                    };
                }
                categoryGroups[category].items++;
                categoryGroups[category].quantity += item.balance || 0;
                categoryGroups[category].value += item.value || 0;
            });
            
            // Calculate total value
            const totalValue = Object.values(categoryGroups).reduce((sum, group) => sum + group.value, 0);
            
            // Create table rows
            Object.entries(categoryGroups).forEach(([category, data]) => {
                const percentage = totalValue > 0 ? ((data.value / totalValue) * 100).toFixed(2) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${category}</strong></td>
                    <td class="numeric">${data.items}</td>
                    <td class="numeric">${data.quantity.toLocaleString()}</td>
                    <td class="numeric">Rs ${formatCurrency(data.value)}</td>
                    <td class="numeric">${percentage}%</td>
                `;
                categoryBody.appendChild(row);
            });
            
            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.style.fontWeight = 'bold';
            totalRow.style.backgroundColor = '#f8f9fa';
            totalRow.innerHTML = `
                <td><strong>TOTAL</strong></td>
                <td class="numeric">${inventoryData.length}</td>
                <td class="numeric">${inventoryData.reduce((sum, item) => sum + (item.balance || 0), 0).toLocaleString()}</td>
                <td class="numeric">Rs ${formatCurrency(totalValue)}</td>
                <td class="numeric">100%</td>
            `;
            categoryBody.appendChild(totalRow);
        }
        
        // Generate stock report
        function generateStockReport() {
            if (inventoryData.length === 0) {
                showAlert('No inventory data available for report', 'warning');
                return;
            }
            
            const reportData = {
                title: 'Stock Report - Western Airducts Lanka (Pvt) Ltd',
                date: new Date().toLocaleDateString('en-GB'),
                items: inventoryData,
                summary: {
                    totalItems: inventoryData.length,
                    totalValue: inventoryData.reduce((sum, item) => sum + (item.value || 0), 0),
                    totalQuantity: inventoryData.reduce((sum, item) => sum + (item.balance || 0), 0)
                }
            };
            
            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
            link.download = `stock_report_${timestamp}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert('Stock report generated successfully!', 'success');
        }
        
        // Generate low stock report
        function generateLowStockReport() {
            const lowStockItems = inventoryData.filter(item => item.balance < 10 && item.balance > 0);
            
            if (lowStockItems.length === 0) {
                showAlert('No low stock items found', 'info');
                return;
            }
            
            const reportData = {
                title: 'Low Stock Report - Western Airducts Lanka (Pvt) Ltd',
                date: new Date().toLocaleDateString('en-GB'),
                threshold: 10,
                items: lowStockItems,
                summary: {
                    totalItems: lowStockItems.length,
                    totalValue: lowStockItems.reduce((sum, item) => sum + (item.value || 0), 0)
                }
            };
            
            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
            link.download = `low_stock_report_${timestamp}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert(`Low stock report generated with ${lowStockItems.length} items!`, 'success');
        }
        
        // Generate transaction report
        function generateTransactionReport() {
            if (historyData.length === 0) {
                showAlert('No transaction history available for report', 'warning');
                return;
            }
            
            const reportData = {
                title: 'Transaction Report - Western Airducts Lanka (Pvt) Ltd',
                date: new Date().toLocaleDateString('en-GB'),
                period: {
                    start: historyStartDate.value,
                    end: historyEndDate.value
                },
                transactions: historyData,
                summary: {
                    totalTransactions: historyData.length,
                    totalStockIn: historyData.filter(t => t.type === 'IN').reduce((sum, t) => sum + (t.quantity || 0), 0),
                    totalStockOut: historyData.filter(t => t.type === 'OUT').reduce((sum, t) => sum + (t.quantity || 0), 0)
                }
            };
            
            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
            link.download = `transaction_report_${timestamp}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert('Transaction report generated successfully!', 'success');
        }
        
        // Generate value report
        function generateValueReport() {
            if (inventoryData.length === 0) {
                showAlert('No inventory data available for report', 'warning');
                return;
            }
            
            // Group by category
            const categoryGroups = {};
            inventoryData.forEach(item => {
                const category = item.category || 'Uncategorized';
                if (!categoryGroups[category]) {
                    categoryGroups[category] = {
                        items: 0,
                        quantity: 0,
                        value: 0
                    };
                }
                categoryGroups[category].items++;
                categoryGroups[category].quantity += item.balance || 0;
                categoryGroups[category].value += item.value || 0;
            });
            
            const totalValue = Object.values(categoryGroups).reduce((sum, group) => sum + group.value, 0);
            
            const reportData = {
                title: 'Inventory Value Analysis - Western Airducts Lanka (Pvt) Ltd',
                date: new Date().toLocaleDateString('en-GB'),
                totalValue: totalValue,
                categories: Object.entries(categoryGroups).map(([category, data]) => ({
                    category,
                    items: data.items,
                    quantity: data.quantity,
                    value: data.value,
                    percentage: totalValue > 0 ? ((data.value / totalValue) * 100).toFixed(2) : 0
                })),
                topItems: inventoryData
                    .sort((a, b) => (b.value || 0) - (a.value || 0))
                    .slice(0, 10)
                    .map(item => ({
                        itemCode: item.itemCode,
                        description: item.description,
                        quantity: item.balance,
                        unitPrice: item.unitPrice,
                        value: item.value
                    }))
            };
            
            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
            link.download = `value_analysis_report_${timestamp}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert('Value analysis report generated successfully!', 'success');
        }
    </script>
</body>
</html>
